#include "ergo_tree.h"
#include <os.h>
#include <string.h>
#include "address.h"
#include "../common/rwbuffer.h"

static const uint8_t C_ERGO_TREE_P2PK_PREFIX[ERGO_TREE_P2PK_PREFIX_LEN] = {0x00, 0x08, 0xcd};

// clang-format off
static const uint8_t C_ERGO_TREE_P2SH_PREFIX[ERGO_TREE_P2SH_PREFIX_LEN] = {
    0x00, 0xea, 0x02, 0xd1, 0x93, 0xb4, 0xcb, 0xe4, 0xe3,
    0x01, 0x0e, 0x04, 0x00, 0x04, 0x30, 0x0e, 0x18
};
// clang-format on

static const uint8_t C_ERGO_TREE_P2SH_SUFFIX[ERGO_TREE_P2SH_SUFFIX_LEN] = {0xd4, 0x08, 0x01};

static const uint8_t C_ERGO_TREE_MINERS_HASH_FEE_MAINNET[105] = {
    0x10, 0x05, 0x04, 0x00, 0x04, 0x00, 0x0e, 0x36, 0x10, 0x02, 0x04, 0xa0, 0x0b, 0x08, 0xcd,
    0x02, 0x79, 0xbe, 0x66, 0x7e, 0xf9, 0xdc, 0xbb, 0xac, 0x55, 0xa0, 0x62, 0x95, 0xce, 0x87,
    0x0b, 0x07, 0x02, 0x9b, 0xfc, 0xdb, 0x2d, 0xce, 0x28, 0xd9, 0x59, 0xf2, 0x81, 0x5b, 0x16,
    0xf8, 0x17, 0x98, 0xea, 0x02, 0xd1, 0x92, 0xa3, 0x9a, 0x8c, 0xc7, 0xa7, 0x01, 0x73, 0x00,
    0x73, 0x01, 0x10, 0x01, 0x02, 0x04, 0x02, 0xd1, 0x96, 0x83, 0x03, 0x01, 0x93, 0xa3, 0x8c,
    0xc7, 0xb2, 0xa5, 0x73, 0x00, 0x00, 0x01, 0x93, 0xc2, 0xb2, 0xa5, 0x73, 0x01, 0x00, 0x74,
    0x73, 0x02, 0x73, 0x03, 0x83, 0x01, 0x08, 0xcd, 0xee, 0xac, 0x93, 0xb1, 0xa5, 0x73, 0x04};

// static const uint8_t C_ERGO_TREE_MINERS_HASH_FEE_TESTNET[105] = {
//     0x10, 0x05, 0x04, 0x00, 0x04, 0x00, 0x0e, 0x36, 0x10, 0x02, 0x04, 0x90, 0x01, 0x08, 0xcd,
//     0x02, 0x79, 0xbe, 0x66, 0x7e, 0xf9, 0xdc, 0xbb, 0xac, 0x55, 0xa0, 0x62, 0x95, 0xce, 0x87,
//     0x0b, 0x07, 0x02, 0x9b, 0xfc, 0xdb, 0x2d, 0xce, 0x28, 0xd9, 0x59, 0xf2, 0x81, 0x5b, 0x16,
//     0xf8, 0x17, 0x98, 0xea, 0x02, 0xd1, 0x92, 0xa3, 0x9a, 0x8c, 0xc7, 0xa7, 0x01, 0x73, 0x00,
//     0x73, 0x01, 0x10, 0x01, 0x02, 0x04, 0x02, 0xd1, 0x96, 0x83, 0x03, 0x01, 0x93, 0xa3, 0x8c,
//     0xc7, 0xb2, 0xa5, 0x73, 0x00, 0x00, 0x01, 0x93, 0xc2, 0xb2, 0xa5, 0x73, 0x01, 0x00, 0x74,
//     0x73, 0x02, 0x73, 0x03, 0x83, 0x01, 0x08, 0xcd, 0xee, 0xac, 0x93, 0xb1, 0xa5, 0x73, 0x04};

void ergo_tree_generate_p2pk(const uint8_t raw_public_key[static PUBLIC_KEY_LEN],
                             uint8_t tree[ERGO_TREE_P2PK_LEN]) {
    RW_BUFFER_FROM_ARRAY_EMPTY(out, tree, ERGO_TREE_P2PK_LEN);

    // Prefix
    rw_buffer_write_bytes(&out, PIC(C_ERGO_TREE_P2PK_PREFIX), ERGO_TREE_P2PK_PREFIX_LEN);

    // Compressed pubkey
    rw_buffer_write_u8(&out, ((raw_public_key[64] & 1) ? 0x03 : 0x02));
    rw_buffer_write_bytes(&out, raw_public_key + 1, 32);
}

bool ergo_tree_parse_p2pk(const uint8_t tree[ERGO_TREE_P2PK_LEN],
                          uint8_t public_key[static COMPRESSED_PUBLIC_KEY_LEN]) {
    if (memcmp(tree, PIC(C_ERGO_TREE_P2PK_PREFIX), ERGO_TREE_P2PK_PREFIX_LEN) != 0) {
        return false;
    }
    if (tree[ERGO_TREE_P2PK_PREFIX_LEN] != 0x02 && tree[ERGO_TREE_P2PK_PREFIX_LEN] != 0x03) {
        return false;
    }
    memmove(public_key, tree + ERGO_TREE_P2PK_PREFIX_LEN, COMPRESSED_PUBLIC_KEY_LEN);
    return true;
}

bool ergo_tree_parse_p2sh(const uint8_t tree[ERGO_TREE_P2SH_LEN],
                          uint8_t hash[static P2SH_HASH_LEN]) {
    if (memcmp(tree, PIC(C_ERGO_TREE_P2SH_PREFIX), ERGO_TREE_P2SH_PREFIX_LEN) != 0) {
        return false;
    }
    if (memcmp(tree + ERGO_TREE_P2SH_PREFIX_LEN + P2SH_HASH_LEN,
               PIC(C_ERGO_TREE_P2SH_SUFFIX),
               ERGO_TREE_P2SH_SUFFIX_LEN) != 0) {
        return false;
    }
    memmove(hash, tree + ERGO_TREE_P2SH_PREFIX_LEN, P2SH_HASH_LEN);
    return true;
}

void ergo_tree_miners_fee_tree(bool is_mainnet, const uint8_t** tree, size_t* size) {
    UNUSED(is_mainnet);
    *size = sizeof(C_ERGO_TREE_MINERS_HASH_FEE_MAINNET);
    *tree = PIC(C_ERGO_TREE_MINERS_HASH_FEE_MAINNET);
}
