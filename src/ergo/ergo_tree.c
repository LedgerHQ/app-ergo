#include "ergo_tree.h"
#include "address.h"
#include "../common/buffer.h"

const uint8_t C_ERGO_TREE_MINERS_HASH_FEE[105] = {
    0x10, 0x05, 0x04, 0x00, 0x04, 0x00, 0x0e, 0x36, 0x10, 0x02, 0x04, 0xa0, 0x0b, 0x08, 0xcd,
    0x02, 0x79, 0xbe, 0x66, 0x7e, 0xf9, 0xdc, 0xbb, 0xac, 0x55, 0xa0, 0x62, 0x95, 0xce, 0x87,
    0x0b, 0x07, 0x02, 0x9b, 0xfc, 0xdb, 0x2d, 0xce, 0x28, 0xd9, 0x59, 0xf2, 0x81, 0x5b, 0x16,
    0xf8, 0x17, 0x98, 0xea, 0x02, 0xd1, 0x92, 0xa3, 0x9a, 0x8c, 0xc7, 0xa7, 0x01, 0x73, 0x00,
    0x73, 0x01, 0x10, 0x01, 0x02, 0x04, 0x02, 0xd1, 0x96, 0x83, 0x03, 0x01, 0x93, 0xa3, 0x8c,
    0xc7, 0xb2, 0xa5, 0x73, 0x00, 0x00, 0x01, 0x93, 0xc2, 0xb2, 0xa5, 0x73, 0x01, 0x00, 0x74,
    0x73, 0x02, 0x73, 0x03, 0x83, 0x01, 0x08, 0xcd, 0xee, 0xac, 0x93, 0xb1, 0xa5, 0x73, 0x04};

void ergo_tree_generate_p2pk(uint8_t raw_public_key[static PUBLIC_KEY_LEN],
                             uint8_t tree[ERGO_TREE_P2PK_LEN]) {
    uint8_t prefix[] = {0x00, 0x08, 0xcd};
    BUFFER_FROM_ARRAY_EMPTY(out, tree, ERGO_TREE_P2PK_LEN);

    // Prefix
    buffer_write_bytes(&out, prefix, sizeof(prefix));

    // Compressed pubkey
    buffer_write_u8(&out, ((raw_public_key[64] & 1) ? 0x03 : 0x02));
    buffer_write_bytes(&out, raw_public_key + 1, 32);
}